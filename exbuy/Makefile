.PHONY: help build up down migrate seed test-* warmup reset clean

# ê¸°ë³¸ ì„¤ì •
SERVER ?= gunicorn-sync
PORT_9000 = http://localhost:9000
PORT_9001 = http://localhost:9001
PORT_9002 = http://localhost:9002
PORT_9003 = http://localhost:9003

help: ## ë„ì›€ë§ í‘œì‹œ
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# ğŸ—ï¸ í™˜ê²½ êµ¬ì„±
build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	docker compose build

rebuild: ## Docker ì´ë¯¸ì§€ ì™„ì „ ì¬ë¹Œë“œ (ìºì‹œ ë¬´ì‹œ)
	@echo "ì´ë¯¸ì§€ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë¹Œë“œí•©ë‹ˆë‹¤..."
	@./rebuild.sh || (echo "rebuild.sh ì‹¤í–‰ ì‹¤íŒ¨" && exit 1)
	@echo "âœ“ ì¬ë¹Œë“œ ì™„ë£Œ"

up: ## ì„œë¹„ìŠ¤ ì‹œì‘ (ê¸°ë³¸: dbë§Œ)
	docker compose up -d db
	@echo "âœ“ DB ì‹œì‘ë¨"

up-sync: ## Gunicorn sync ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-sync up -d

up-gevent: ## Gunicorn gevent ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-gevent up -d

up-gthread: ## Gunicorn gthread ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-gthread up -d

up-uvicorn: ## Uvicorn ì„œë²„ ì‹œì‘
	docker compose --profile uvicorn up -d

up-all: ## ëª¨ë“  ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-sync --profile gunicorn-gevent --profile gunicorn-gthread --profile uvicorn up -d

down: ## ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ
	docker compose down

logs: ## ë¡œê·¸ í™•ì¸
	docker compose logs -f

# ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤
migrate: ## ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
	docker compose run --rm web-gunicorn-sync python manage.py migrate

seed-small: ## ì†Œê·œëª¨ ë°ì´í„° ì‹œë”© (1K/5K/10K)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 1000 --orders 5000 --reviews 10000

seed-medium: ## ì¤‘ê·œëª¨ ë°ì´í„° ì‹œë”© (10K/50K/100K)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 10000 --orders 50000 --reviews 100000

seed-large: ## ëŒ€ê·œëª¨ ë°ì´í„° ì‹œë”© (100K/500K/1M)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 100000 --orders 500000 --reviews 1000000 --batch-size 5000

seed: seed-medium ## ê¸°ë³¸ ë°ì´í„° ì‹œë”© (ì¤‘ê·œëª¨)

# ğŸ”¥ ì›Œë°ì—…
warmup: ## ìºì‹œ ì›Œë°ì—…
	@echo "ì›Œë°ì—… ì¤‘... ($(BASE_URL))"
	@BASE_URL=$(or $(BASE_URL),$(PORT_9000)) ./warmup.sh || (echo "warmup.sh ì‹¤í–‰ ì‹¤íŒ¨" && exit 1)
	@echo "âœ“ ì›Œë°ì—… ì™„ë£Œ"

# ğŸ§¹ ë¦¬ì…‹
reset: ## ë°ì´í„° ì´ˆê¸°í™”
	@echo "ë°ì´í„° ì´ˆê¸°í™” ì¤‘..."
	@./reset-test.sh || (echo "reset-test.sh ì‹¤í–‰ ì‹¤íŒ¨" && exit 1)
	@echo "âœ“ ì´ˆê¸°í™” ì™„ë£Œ"

# ğŸ“Š ë¶€í•˜ í…ŒìŠ¤íŠ¸
test-read-heavy: ## ì½ê¸° ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	K6_PROMETHEUS_RW_SERVER_URL=http://localhost:8428/api/v1/write \
	BASE_URL=$(PORT_9000) k6 run \
		--tag server_type=$(SERVER) \
		--tag scenario=read-heavy \
		--out json=results/$(SERVER)-read-heavy.json \
		--out experimental-prometheus-rw \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-read-heavy.log \
		k6-scripts/read-heavy.js

test-write-heavy: ## ì“°ê¸° ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	K6_PROMETHEUS_RW_SERVER_URL=http://localhost:8428/api/v1/write \
	BASE_URL=$(PORT_9000) k6 run \
		--tag server_type=$(SERVER) \
		--tag scenario=write-heavy \
		--out json=results/$(SERVER)-write-heavy.json \
		--out experimental-prometheus-rw \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-write-heavy.log \
		k6-scripts/write-heavy.js

test-mixed: ## í˜¼í•© í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	K6_PROMETHEUS_RW_SERVER_URL=http://localhost:8428/api/v1/write \
	BASE_URL=$(PORT_9000) k6 run \
		--tag server_type=$(SERVER) \
		--tag scenario=mixed \
		--out json=results/$(SERVER)-mixed.json \
		--out experimental-prometheus-rw \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-mixed.log \
		k6-scripts/mixed.js

test-read-only: ## ìˆœìˆ˜ ì½ê¸° ì „ìš© í…ŒìŠ¤íŠ¸ (5ë¶„ 30ì´ˆ, ë§¤ë¶„ 30ì´ˆ ì‹œì‘)
	@echo "ğŸ’¡ VU ë³€ê²½: make test-read-only SERVER=<server> PORT_9000=<url> MAX_VU=<number>"
	@echo "=== í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
	@echo "ì„œë²„ íƒ€ì…: $(SERVER)"
	@echo "ì‹œë‚˜ë¦¬ì˜¤: read-only"
	@START_TIME=$$(date '+%Y-%m-%d %H:%M:%S'); \
	echo "ì‹œì‘ ì˜ˆì •: $$START_TIME"; \
	echo "VU ì„¤ì •: $(or $(MAX_VU),200)"; \
	echo "==================================="; \
	echo "ë§¤ë¶„ 30ì´ˆì— ì‹œì‘í•˜ë„ë¡ ëŒ€ê¸° ì¤‘..."; \
	current=$$(date +%s); \
	seconds=$$((current % 60)); \
	if [ $$seconds -lt 30 ]; then \
		sleep $$((30 - seconds)); \
	else \
		sleep $$((90 - seconds)); \
	fi; \
	START_TIME=$$(date '+%Y-%m-%d %H:%M:%S'); \
	echo "ì‹¤ì œ ì‹œì‘: $$START_TIME"; \
	mkdir -p results; \
	mkdir -p ../monitoring/k6/logs; \
	K6_PROMETHEUS_RW_SERVER_URL=http://localhost:8428/api/v1/write \
	BASE_URL=$(PORT_9000) k6 run \
		--tag server_type=$(SERVER) \
		--tag scenario=read-only \
		--out json=results/$(SERVER)-read-only.json \
		--out experimental-prometheus-rw \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-read-only.log \
		k6-scripts/read-only.js; \
	END_TIME=$$(date '+%Y-%m-%d %H:%M:%S'); \
	echo "==================================="; \
	echo "=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="; \
	echo "ì„œë²„ íƒ€ì…: $(SERVER)"; \
	echo "ì‹œë‚˜ë¦¬ì˜¤: read-only"; \
	echo "ì‹œì‘ ì‹œê°„: $$START_TIME"; \
	echo "ì¢…ë£Œ ì‹œê°„: $$END_TIME"; \
	echo "==================================="

# ì„œë²„ë³„ ì „ì²´ í…ŒìŠ¤íŠ¸
test-gunicorn-sync: ## Gunicorn sync ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn sync í…ŒìŠ¤íŠ¸ ==="
	-@make warmup
	-@make test-read-heavy SERVER=gunicorn-sync PORT_9000=http://localhost:9000
	@sleep 10
	-@make test-write-heavy SERVER=gunicorn-sync PORT_9000=http://localhost:9000
	@sleep 10
	-@make test-mixed SERVER=gunicorn-sync PORT_9000=http://localhost:9000

test-gunicorn-gevent: ## Gunicorn gevent ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gevent í…ŒìŠ¤íŠ¸ ==="
	-@make warmup BASE_URL=http://localhost:9001
	-@make test-read-heavy SERVER=gunicorn-gevent PORT_9000=http://localhost:9001
	@sleep 10
	-@make test-write-heavy SERVER=gunicorn-gevent PORT_9000=http://localhost:9001
	@sleep 10
	-@make test-mixed SERVER=gunicorn-gevent PORT_9000=http://localhost:9001

test-gunicorn-gthread: ## Gunicorn gthread ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gthread í…ŒìŠ¤íŠ¸ ==="
	-@make warmup BASE_URL=http://localhost:9002
	-@make test-read-heavy SERVER=gunicorn-gthread PORT_9000=http://localhost:9002
	@sleep 10
	-@make test-write-heavy SERVER=gunicorn-gthread PORT_9000=http://localhost:9002
	@sleep 10
	-@make test-mixed SERVER=gunicorn-gthread PORT_9000=http://localhost:9002

test-uvicorn: ## Uvicorn ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Uvicorn í…ŒìŠ¤íŠ¸ ==="
	-@make warmup BASE_URL=http://localhost:9003
	-@make test-read-heavy SERVER=uvicorn PORT_9000=http://localhost:9003
	@sleep 10
	-@make test-write-heavy SERVER=uvicorn PORT_9000=http://localhost:9003
	@sleep 10
	-@make test-mixed SERVER=uvicorn PORT_9000=http://localhost:9003

# ì„œë²„ë³„ Read-Only í…ŒìŠ¤íŠ¸
test-read-only-gunicorn-sync: ## Gunicorn sync Read-Only í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn sync Read-Only í…ŒìŠ¤íŠ¸ ==="
	@echo "ğŸ’¡ VU ë³€ê²½: make test-read-only-gunicorn-sync MAX_VU=300"
	-@make warmup BASE_URL=http://localhost:9000
	-@make test-read-only SERVER=gunicorn-sync PORT_9000=http://localhost:9000

test-read-only-gunicorn-gevent: ## Gunicorn gevent Read-Only í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gevent Read-Only í…ŒìŠ¤íŠ¸ ==="
	@echo "ğŸ’¡ VU ë³€ê²½: make test-read-only-gunicorn-gevent MAX_VU=300"
	-@make warmup BASE_URL=http://localhost:9001
	-@make test-read-only SERVER=gunicorn-gevent PORT_9000=http://localhost:9001

test-read-only-gunicorn-gthread: ## Gunicorn gthread Read-Only í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gthread Read-Only í…ŒìŠ¤íŠ¸ ==="
	@echo "ğŸ’¡ VU ë³€ê²½: make test-read-only-gunicorn-gthread MAX_VU=300"
	-@make warmup BASE_URL=http://localhost:9002
	-@make test-read-only SERVER=gunicorn-gthread PORT_9000=http://localhost:9002

test-read-only-uvicorn: ## Uvicorn Read-Only í…ŒìŠ¤íŠ¸
	@echo "=== Uvicorn Read-Only í…ŒìŠ¤íŠ¸ ==="
	@echo "ğŸ’¡ VU ë³€ê²½: make test-read-only-uvicorn MAX_VU=300"
	-@make warmup BASE_URL=http://localhost:9003
	-@make test-read-only SERVER=uvicorn PORT_9000=http://localhost:9003

test-all: ## ëª¨ë“  ì„œë²„ ë¹„êµ í…ŒìŠ¤íŠ¸
	@echo "=== ì „ì²´ ì„œë²„ ë¹„êµ í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
	@make up-all
	@sleep 10
	@make test-gunicorn-sync
	@make reset
	@make test-gunicorn-gevent
	@make reset
	@make test-gunicorn-gthread
	@make reset
	@make test-uvicorn
	@echo "âœ“ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ. results/ ë””ë ‰í„°ë¦¬ í™•ì¸"

# ğŸ“ˆ ê²°ê³¼ ë¶„ì„
compare: ## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¹„êµ
	@echo "ê²°ê³¼ ë¹„êµ ì¤‘..."
	@ls -lh results/
	@echo "\nì£¼ìš” ë©”íŠ¸ë¦­:"
	@grep -h "http_req_duration" results/*.json | head -10 || true

# ğŸ§¼ ì •ë¦¬
clean: ## ê²°ê³¼ íŒŒì¼ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
	rm -rf results/
	docker compose down -v
	docker system prune -f

clean-data: ## ë°ì´í„° ë° ë³¼ë¥¨ ì™„ì „ ì‚­ì œ
	docker compose down -v
	@echo "âš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"

# ğŸ” ë””ë²„ê¹…
shell: ## Django shell ì ‘ì†
	docker compose exec web-gunicorn-sync python manage.py shell

dbshell: ## DB shell ì ‘ì†
	docker compose exec db psql -U postgres -d exbuy

check-health: ## í—¬ìŠ¤ ì²´í¬
	@echo "ì„œë²„ ìƒíƒœ í™•ì¸:"
	@curl -s http://localhost:9000/api/health 2>/dev/null && echo "âœ“ Gunicorn sync (9000)" || echo "âœ— Gunicorn sync (9000)"
	@curl -s http://localhost:9001/api/health 2>/dev/null && echo "âœ“ Gunicorn gevent (9001)" || echo "âœ— Gunicorn gevent (9001)"
	@curl -s http://localhost:9002/api/health 2>/dev/null && echo "âœ“ Gunicorn gthread (9002)" || echo "âœ— Gunicorn gthread (9002)"
	@curl -s http://localhost:9003/api/health 2>/dev/null && echo "âœ“ Uvicorn (9003)" || echo "âœ— Uvicorn (9003)"

stats: ## Docker ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
	docker stats --no-stream

# ğŸš€ ë¹ ë¥¸ ì‹œì‘
quickstart: ## ë¹ ë¥¸ ì‹œì‘ (ë¹Œë“œ â†’ ì‹œì‘ â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ ì‹œë”© â†’ í…ŒìŠ¤íŠ¸)
	@echo "=== ë¹ ë¥¸ ì‹œì‘ ==="
	@make build
	@make up
	@sleep 5
	@make migrate
	@make seed-small
	@make up-sync
	@sleep 5
	@make check-health
	@echo "\nâœ“ ì¤€ë¹„ ì™„ë£Œ! í…ŒìŠ¤íŠ¸ ì‹¤í–‰:"
	@echo "  make test-read-heavy"
	@echo "  make test-mixed"
