.PHONY: help build up down migrate seed test-* warmup reset clean

# ê¸°ë³¸ ì„¤ì •
SERVER ?= gunicorn-sync
PORT_8000 = http://localhost:8000
PORT_8001 = http://localhost:8001
PORT_8002 = http://localhost:8002
PORT_8003 = http://localhost:8003

help: ## ë„ì›€ë§ í‘œì‹œ
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# ğŸ—ï¸ í™˜ê²½ êµ¬ì„±
build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	docker compose build

up: ## ì„œë¹„ìŠ¤ ì‹œì‘ (ê¸°ë³¸: dbë§Œ)
	docker compose up -d db
	@echo "âœ“ DB ì‹œì‘ë¨"

up-sync: ## Gunicorn sync ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-sync up -d

up-gevent: ## Gunicorn gevent ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-gevent up -d

up-gthread: ## Gunicorn gthread ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-gthread up -d

up-uvicorn: ## Uvicorn ì„œë²„ ì‹œì‘
	docker compose --profile uvicorn up -d

up-all: ## ëª¨ë“  ì„œë²„ ì‹œì‘
	docker compose --profile gunicorn-sync --profile gunicorn-gevent --profile gunicorn-gthread --profile uvicorn up -d

down: ## ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ
	docker compose down

logs: ## ë¡œê·¸ í™•ì¸
	docker compose logs -f

# ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤
migrate: ## ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
	docker compose run --rm web-gunicorn-sync python manage.py migrate

seed-small: ## ì†Œê·œëª¨ ë°ì´í„° ì‹œë”© (1K/5K/10K)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 1000 --orders 5000 --reviews 10000

seed-medium: ## ì¤‘ê·œëª¨ ë°ì´í„° ì‹œë”© (10K/50K/100K)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 10000 --orders 50000 --reviews 100000

seed-large: ## ëŒ€ê·œëª¨ ë°ì´í„° ì‹œë”© (100K/500K/1M)
	docker compose run --rm web-gunicorn-sync python manage.py seed_data --products 100000 --orders 500000 --reviews 1000000 --batch-size 5000

seed: seed-medium ## ê¸°ë³¸ ë°ì´í„° ì‹œë”© (ì¤‘ê·œëª¨)

# ğŸ”¥ ì›Œë°ì—…
warmup: ## ìºì‹œ ì›Œë°ì—…
	@echo "ì›Œë°ì—… ì¤‘..."
	@./warmup.sh || (echo "warmup.sh ì‹¤í–‰ ì‹¤íŒ¨" && exit 1)
	@echo "âœ“ ì›Œë°ì—… ì™„ë£Œ"

# ğŸ§¹ ë¦¬ì…‹
reset: ## ë°ì´í„° ì´ˆê¸°í™”
	@echo "ë°ì´í„° ì´ˆê¸°í™” ì¤‘..."
	@./reset-test.sh || (echo "reset-test.sh ì‹¤í–‰ ì‹¤íŒ¨" && exit 1)
	@echo "âœ“ ì´ˆê¸°í™” ì™„ë£Œ"

# ğŸ“Š ë¶€í•˜ í…ŒìŠ¤íŠ¸
test-read-heavy: ## ì½ê¸° ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	BASE_URL=$(PORT_8000) k6 run \
		--out json=results/$(SERVER)-read-heavy.json \
		--out influxdb=http://localhost:8089/exbuy \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-read-heavy.log \
		k6-scripts/read-heavy.js

test-write-heavy: ## ì“°ê¸° ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	BASE_URL=$(PORT_8000) k6 run \
		--out json=results/$(SERVER)-write-heavy.json \
		--out influxdb=http://localhost:8089/exbuy \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-write-heavy.log \
		k6-scripts/write-heavy.js

test-mixed: ## í˜¼í•© í…ŒìŠ¤íŠ¸
	@mkdir -p results
	@mkdir -p ../monitoring/k6/logs
	BASE_URL=$(PORT_8000) k6 run \
		--out json=results/$(SERVER)-mixed.json \
		--out influxdb=http://localhost:8089/exbuy \
		--log-output=file=../monitoring/k6/logs/$(SERVER)-mixed.log \
		k6-scripts/mixed.js

# ì„œë²„ë³„ ì „ì²´ í…ŒìŠ¤íŠ¸
test-gunicorn-sync: ## Gunicorn sync ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn sync í…ŒìŠ¤íŠ¸ ==="
	@make warmup
	@make test-read-heavy SERVER=gunicorn-sync PORT_8000=http://localhost:8000
	@sleep 10
	@make test-write-heavy SERVER=gunicorn-sync PORT_8000=http://localhost:8000
	@sleep 10
	@make test-mixed SERVER=gunicorn-sync PORT_8000=http://localhost:8000

test-gunicorn-gevent: ## Gunicorn gevent ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gevent í…ŒìŠ¤íŠ¸ ==="
	@make warmup
	@make test-read-heavy SERVER=gunicorn-gevent PORT_8000=http://localhost:8001
	@sleep 10
	@make test-write-heavy SERVER=gunicorn-gevent PORT_8000=http://localhost:8001
	@sleep 10
	@make test-mixed SERVER=gunicorn-gevent PORT_8000=http://localhost:8001

test-gunicorn-gthread: ## Gunicorn gthread ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Gunicorn gthread í…ŒìŠ¤íŠ¸ ==="
	@make warmup
	@make test-read-heavy SERVER=gunicorn-gthread PORT_8000=http://localhost:8002
	@sleep 10
	@make test-write-heavy SERVER=gunicorn-gthread PORT_8000=http://localhost:8002
	@sleep 10
	@make test-mixed SERVER=gunicorn-gthread PORT_8000=http://localhost:8002

test-uvicorn: ## Uvicorn ì „ì²´ í…ŒìŠ¤íŠ¸
	@echo "=== Uvicorn í…ŒìŠ¤íŠ¸ ==="
	@make warmup
	@make test-read-heavy SERVER=uvicorn PORT_8000=http://localhost:8003
	@sleep 10
	@make test-write-heavy SERVER=uvicorn PORT_8000=http://localhost:8003
	@sleep 10
	@make test-mixed SERVER=uvicorn PORT_8000=http://localhost:8003

test-all: ## ëª¨ë“  ì„œë²„ ë¹„êµ í…ŒìŠ¤íŠ¸
	@echo "=== ì „ì²´ ì„œë²„ ë¹„êµ í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
	@make up-all
	@sleep 10
	@make test-gunicorn-sync
	@make reset
	@make test-gunicorn-gevent
	@make reset
	@make test-gunicorn-gthread
	@make reset
	@make test-uvicorn
	@echo "âœ“ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ. results/ ë””ë ‰í„°ë¦¬ í™•ì¸"

# ğŸ“ˆ ê²°ê³¼ ë¶„ì„
compare: ## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¹„êµ
	@echo "ê²°ê³¼ ë¹„êµ ì¤‘..."
	@ls -lh results/
	@echo "\nì£¼ìš” ë©”íŠ¸ë¦­:"
	@grep -h "http_req_duration" results/*.json | head -10 || true

# ğŸ§¼ ì •ë¦¬
clean: ## ê²°ê³¼ íŒŒì¼ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
	rm -rf results/
	docker compose down -v
	docker system prune -f

clean-data: ## ë°ì´í„° ë° ë³¼ë¥¨ ì™„ì „ ì‚­ì œ
	docker compose down -v
	@echo "âš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"

# ğŸ” ë””ë²„ê¹…
shell: ## Django shell ì ‘ì†
	docker compose exec web-gunicorn-sync python manage.py shell

dbshell: ## DB shell ì ‘ì†
	docker compose exec db psql -U postgres -d exbuy

check-health: ## í—¬ìŠ¤ ì²´í¬
	@echo "ì„œë²„ ìƒíƒœ í™•ì¸:"
	@curl -s http://localhost:8000/api/health 2>/dev/null && echo "âœ“ Gunicorn sync (8000)" || echo "âœ— Gunicorn sync (8000)"
	@curl -s http://localhost:8001/api/health 2>/dev/null && echo "âœ“ Gunicorn gevent (8001)" || echo "âœ— Gunicorn gevent (8001)"
	@curl -s http://localhost:8002/api/health 2>/dev/null && echo "âœ“ Gunicorn gthread (8002)" || echo "âœ— Gunicorn gthread (8002)"
	@curl -s http://localhost:8003/api/health 2>/dev/null && echo "âœ“ Uvicorn (8003)" || echo "âœ— Uvicorn (8003)"

stats: ## Docker ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
	docker stats --no-stream

# ğŸš€ ë¹ ë¥¸ ì‹œì‘
quickstart: ## ë¹ ë¥¸ ì‹œì‘ (ë¹Œë“œ â†’ ì‹œì‘ â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ ì‹œë”© â†’ í…ŒìŠ¤íŠ¸)
	@echo "=== ë¹ ë¥¸ ì‹œì‘ ==="
	@make build
	@make up
	@sleep 5
	@make migrate
	@make seed-small
	@make up-sync
	@sleep 5
	@make check-health
	@echo "\nâœ“ ì¤€ë¹„ ì™„ë£Œ! í…ŒìŠ¤íŠ¸ ì‹¤í–‰:"
	@echo "  make test-read-heavy"
	@echo "  make test-mixed"
